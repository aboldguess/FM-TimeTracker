<!--
Mini-README: Timesheet operations hub for logging time, tracking totals, and auditing recent entries.
-->
{% extends 'base.html' %}
{% block content %}
<section>
  <h1>Timesheets</h1>
  <p class="instruction">Log work in real time, review recent entries, and keep project delivery transparent.</p>

  <div class="card-grid">
    <article class="card">
      <h3>Approved logged hours</h3>
      <p>{{ '%.2f'|format(total_hours or 0) }}</p>
    </article>
    <article class="card">
      <h3>Entries on record</h3>
      <p>{{ entry_count }}</p>
    </article>
    <article class="card">
      <h3>Role-based guidance</h3>
      <p>
        {% if user.role == 'admin' %}
        Review team activity and compliance across programmes.
        {% elif user.role == 'programme_manager' %}
        Validate effort allocations against programme budgets.
        {% elif user.role == 'project_manager' %}
        Monitor task burn-downs and resourcing accuracy.
        {% else %}
        Capture your daily activity for billing and payroll.
        {% endif %}
      </p>
    </article>
  </div>

  <div class="panel">
    <h2>Log new time</h2>
    <p class="helper">This form writes directly to the secure timesheet service. Use dropdowns to avoid data quality issues.</p>
    {% if error %}
    <p class="error">{{ error }}</p>
    {% endif %}
    <form class="form" method="post" action="/timesheets/form">
      <div class="form-grid">
        <div>
          <label for="entry_date">Entry date</label>
          <input id="entry_date" name="entry_date" type="date" value="{{ today }}" required />
        </div>
        <div>
          <label for="hours">Hours</label>
          <input id="hours" name="hours" type="number" step="0.25" min="0.25" max="24" required />
        </div>
        <div>
          <label for="project_id">Project (optional)</label>
          <select id="project_id" name="project_id">
            <option value="">Select project</option>
            {% for project in projects %}
            <option value="{{ project.id }}">{{ project.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="task_id">Task (optional)</label>
          <select id="task_id" name="task_id">
            <option value="">Select task</option>
            {% for task in tasks %}
            <option value="{{ task.id }}">{{ task.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <label for="description">Work description</label>
        <textarea id="description" name="description" placeholder="Describe what you worked on..." required></textarea>
      </div>
      <button class="btn" type="submit">Submit time entry</button>
    </form>
  </div>

  <div class="panel">
    <h2>Week status ({{ week_start }} â†’ {{ week_end }})</h2>
    <p class="helper">Days are colour coded: missing, partially filled, or complete (including approved leave days).</p>
    <div class="status-legend">
      <span class="status-chip status-missing">Missing</span>
      <span class="status-chip status-partial">Partial</span>
      <span class="status-chip status-complete">Complete</span>
    </div>
    <div class="status-grid">
      {% for day in day_statuses %}
      <div class="status-cell status-{{ day.status }} {% if day.is_today %}status-today{% endif %}">
        <div class="status-date">{{ day.date.strftime('%a %d %b') }}</div>
        <div class="status-hours">{{ '%.2f'|format(day.logged) }}h / {{ '%.2f'|format(day.expected) }}h</div>
      </div>
      {% endfor %}
    </div>
    <div class="panel-inline">
      <div>
        <p><strong>Status:</strong> {{ week_summary.status.value if week_summary else 'draft' }}</p>
        {% if week_summary and week_summary.submit_note %}
        <p class="helper"><strong>Submit note:</strong> {{ week_summary.submit_note }}</p>
        {% endif %}
        {% if week_summary and week_summary.approval_note %}
        <p class="helper"><strong>Approval note:</strong> {{ week_summary.approval_note }}</p>
        {% endif %}
      </div>
      <div class="panel-actions">
        {% if not week_summary or week_summary.status.value == 'draft' %}
        <form method="post" action="/timesheets/submit-week" class="inline-form">
          <input type="hidden" name="week_start" value="{{ week_start }}" />
          <input type="text" name="submit_note" placeholder="Optional note to line manager" />
          <button class="btn" type="submit">Submit week</button>
        </form>
        {% elif week_summary.status.value == 'submitted' %}
        <form method="post" action="/timesheets/unsubmit-week" class="inline-form">
          <input type="hidden" name="week_start" value="{{ week_start }}" />
          <button class="btn secondary" type="submit">Unsubmit week</button>
        </form>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="panel">
    <h2>Recent entries</h2>
    <table class="data-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Hours</th>
          <th>Project</th>
          <th>Task</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in recent_entries %}
        <tr>
          <td>{{ entry.entry_date }}</td>
          <td>{{ '%.2f'|format(entry.hours) }}</td>
          <td>{{ entry.project_id or '-' }}</td>
          <td>{{ entry.task_id or '-' }}</td>
          <td>{{ entry.description }}</td>
          <td>
            <details>
              <summary>Edit</summary>
              <form class="form compact" method="post" action="/timesheets/{{ entry.id }}/edit">
                <input type="date" name="entry_date" value="{{ entry.entry_date }}" required />
                <input type="number" name="hours" step="0.25" min="0.25" max="24" value="{{ entry.hours }}" required />
                <select name="project_id">
                  <option value="">Select project</option>
                  {% for project in projects %}
                  <option value="{{ project.id }}" {% if entry.project_id == project.id %}selected{% endif %}>{{ project.name }}</option>
                  {% endfor %}
                </select>
                <select name="task_id">
                  <option value="">Select task</option>
                  {% for task in tasks %}
                  <option value="{{ task.id }}" {% if entry.task_id == task.id %}selected{% endif %}>{{ task.name }}</option>
                  {% endfor %}
                </select>
                <textarea name="description" required>{{ entry.description }}</textarea>
                <button class="btn secondary" type="submit">Save changes</button>
              </form>
            </details>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="instruction">No entries yet. Submit your first timesheet above.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
