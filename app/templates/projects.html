<!--
Mini-README: Project delivery hub with portfolio metrics, recent activity, and creation workflow.
-->
{% extends 'base.html' %}
{% block contextual_nav %}
<nav class="context-toolbar" aria-label="Project sections">
  <a href="#overview" class="context-pill">Overview</a>
  <a href="#create-project" class="context-pill">Create project</a>
  <a href="#recent-projects" class="context-pill">Recent projects</a>
</nav>
{% endblock %}
{% block content %}
<section id="overview">
  <h1>Projects</h1>
  <p class="instruction">Centralise delivery plans, budgets, and milestones for every active project.</p>

  <div class="card-grid">
    <article class="card">
      <h3>Total projects</h3>
      <p>{{ total_projects }}</p>
    </article>
    <article class="card">
      <h3>Active projects</h3>
      <p>{{ active_projects }}</p>
    </article>
    <article class="card">
      <h3>Governance focus</h3>
      <p>Use work packages, tasks, and resource requirements to stay on track.</p>
    </article>
  </div>

  <div class="panel" id="create-project">
    <h2>Create new project</h2>
    <p class="helper">Available to admins, programme managers, and project managers.</p>
    <form class="form" method="post" action="/projects/form">
      {{ csrf_input(request) }}
      <div class="form-grid">
        <div>
          <label for="name">Project name</label>
          <input id="name" name="name" type="text" placeholder="Project Atlas" required />
        </div>
        <div>
          <label for="customer_id">Customer</label>
          <select id="customer_id" name="customer_id" required>
            <option value="">Select customer</option>
            {% for customer in customers %}
            <option value="{{ customer.id }}">{{ customer.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="programme_id">Programme (optional)</label>
          <select id="programme_id" name="programme_id">
            <option value="">Select programme</option>
            {% for programme in programmes %}
            <option value="{{ programme.id }}">{{ programme.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="manager_id">Delivery manager (optional)</label>
          <select id="manager_id" name="manager_id">
            <option value="">Select manager</option>
            {% for manager in managers %}
            <option value="{{ manager.id }}">{{ manager.full_name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label for="planned_hours">Planned hours</label>
          <input id="planned_hours" name="planned_hours" type="number" step="0.5" min="0" />
        </div>
        <div>
          <label for="planned_material_budget">Material budget</label>
          <input id="planned_material_budget" name="planned_material_budget" type="number" step="0.01" min="0" />
        </div>
        <div>
          <label for="planned_subcontract_budget">Subcontract budget</label>
          <input id="planned_subcontract_budget" name="planned_subcontract_budget" type="number" step="0.01" min="0" />
        </div>
      </div>
      <div>
        <label for="description">Project brief</label>
        <textarea id="description" name="description" placeholder="Describe scope, risks, and objectives" required></textarea>
      </div>
      <div>
        <label for="initial_tasks">Initial tasks (optional)</label>
        <textarea id="initial_tasks" name="initial_tasks" placeholder="One task name per line, e.g.&#10;Requirements workshop&#10;Draft delivery plan"></textarea>
        <p class="helper">Project and programme managers can seed tasks now and refine them later below.</p>
      </div>
      <button class="btn" type="submit">Create project</button>
    </form>
  </div>

  <div class="panel" id="recent-projects">
    <h2>Recent projects</h2>
    <table class="data-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Customer</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Planned hours</th>
          <th>Task controls</th>
        </tr>
      </thead>
      <tbody>
        {% for project in recent_projects %}
        <tr>
          <td>{{ project.name }}</td>
          <td>{{ project.customer.name if project.customer else '-' }}</td>
          <td><span class="pill">{{ project.status }}</span></td>
          <td>{{ project.progress_percent }}%</td>
          <td>{{ project.planned_hours }}</td>
          <td>
            <details>
              <summary>Manage tasks</summary>
              <div class="panel" style="margin-top: 0.75rem;">
                <h3>Add task</h3>
                <form class="form" method="post" action="/projects/{{ project.id }}/tasks/form">
      {{ csrf_input(request) }}
                  <div class="form-grid">
                    <div>
                      <label for="task_name_{{ project.id }}">Task name</label>
                      <input id="task_name_{{ project.id }}" name="name" type="text" required />
                    </div>
                    <div>
                      <label for="task_hours_{{ project.id }}">Planned hours</label>
                      <input id="task_hours_{{ project.id }}" name="planned_hours" type="number" step="0.5" min="0" />
                    </div>
                  </div>
                  <div>
                    <label for="task_description_{{ project.id }}">Description</label>
                    <textarea id="task_description_{{ project.id }}" name="description" placeholder="Optional delivery notes"></textarea>
                  </div>
                  <button class="btn" type="submit">Add task</button>
                </form>

                <h3 style="margin-top: 1rem;">Existing tasks</h3>
                {% set namespace = namespace(tasks=[]) %}
                {% for work_package in project.work_packages %}
                  {% for task in work_package.tasks %}
                    {% set namespace.tasks = namespace.tasks + [task] %}
                  {% endfor %}
                {% endfor %}
                {% for task in namespace.tasks %}
                  <form class="form" method="post" action="/projects/{{ project.id }}/tasks/{{ task.id }}/update" style="border-top: 1px solid var(--line); padding-top: 0.8rem; margin-top: 0.8rem;">
      {{ csrf_input(request) }}
                    <div class="form-grid">
                      <div>
                        <label for="existing_task_name_{{ task.id }}">Task name</label>
                        <input id="existing_task_name_{{ task.id }}" name="name" type="text" value="{{ task.name }}" required />
                      </div>
                      <div>
                        <label for="existing_task_hours_{{ task.id }}">Planned hours</label>
                        <input id="existing_task_hours_{{ task.id }}" name="planned_hours" type="number" step="0.5" min="0" value="{{ task.planned_hours }}" />
                      </div>
                      <div>
                        <label for="existing_task_progress_{{ task.id }}">Progress %</label>
                        <input id="existing_task_progress_{{ task.id }}" name="progress_percent" type="number" step="1" min="0" max="100" value="{{ task.progress_percent }}" />
                      </div>
                    </div>
                    <div>
                      <label for="existing_task_description_{{ task.id }}">Description</label>
                      <textarea id="existing_task_description_{{ task.id }}" name="description">{{ task.description }}</textarea>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                      <button class="btn" type="submit">Save</button>
                      <button class="btn btn-secondary" formaction="/projects/{{ project.id }}/tasks/{{ task.id }}/delete" formmethod="post" onclick="return confirm('Delete this task?');">Delete</button>
                    </div>
                  </form>
                {% else %}
                  <p class="instruction">No tasks created yet for this project.</p>
                {% endfor %}
              </div>
            </details>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="instruction">No projects created yet.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
